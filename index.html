<!DOCTYPE html>
<html>

<script>
(function(w,d,s,g,js,fs){
  g=w.gapi||(w.gapi={});g.analytics={q:[],ready:function(f){this.q.push(f);}};
  js=d.createElement(s);fs=d.getElementsByTagName(s)[0];
  js.src='https://apis.google.com/js/platform.js';
  fs.parentNode.insertBefore(js,fs);js.onload=function(){g.load('analytics');};
}(window,document,'script'));
</script>
        
<body>
    
    <div id="embed-api-auth-container"></div>
    <div id="view-selector-container"></div>
    <div id="view-name"></div>
    <div id="active-users-container"></div>
    <div id="date-range-selector-1-container"></div>
    
    <p id="AOV">
    </p>
    <p id="RPR">
    </p>
    <p id="TBP">
    </p>
    <p id="REV">
    </p>
    <p id="CLTV">
    </p>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.2/moment.min.js"></script>
<script src="https://ga-dev-tools.appspot.com/public/javascript/embed-api/components/view-selector2.js"></script>
<script src="https://ga-dev-tools.appspot.com/public/javascript/embed-api/components/date-range-selector.js"></script>
<script src="https://ga-dev-tools.appspot.com/public/javascript/embed-api/components/active-users.js"></script>
<link rel="stylesheet" href="https://ga-dev-tools.appspot.com/public/css/chartjs-visualizations.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    
    <form action="https://4253c6aa.ngrok.io" method="GET">
        <input type='date' id='date_sel' oninput='date_update();'>
    </form>
    <form method="get" action="https://4253c6aa.ngrok.io">
        <input type='date' id='date_sel1' oninput='date_update();'>
    </form>
    
    <div class="Chartjs">
        <h2 id="GAOV"></h2>
        <figure class="Chartjs-figure" id="chart-1-container"></figure>
        <ol class="Chartjs-legend" id="legend-1-container"></ol>
    </div>
    <div class="Chartjs">
        <h2 id="CR"></h2>
        <figure class="Chartjs-figure" id="chart-2-container"></figure>
        <ol class="Chartjs-legend" id="legend-2-container"></ol>
    </div>
    <div class="Chartjs">
        <h2 id="GREV"></h2>
        <figure class="Chartjs-figure" id="chart-3-container"></figure>
        <ol class="Chartjs-legend" id="legend-3-container"></ol>
    </div>
    <div class="Chartjs">
        <h2 id="PVV"></h2>
        <figure class="Chartjs-figure" id="chart-4-container"></figure>
        <ol class="Chartjs-legend" id="legend-4-container"></ol>
    </div>
    <div class="Chartjs">
        <h2 id="TRAN"></h2>
        <figure class="Chartjs-figure" id="chart-6-container"></figure>
        <ol class="Chartjs-legend" id="legend-6-container"></ol>
    </div>
    <div class="Chartjs">
        <h2 id="SESS"></h2>
        <figure class="Chartjs-figure" id="chart-7-container"></figure>
        <ol class="Chartjs-legend" id="legend-7-container"></ol>
    </div>
        <div class="Chartjs">
        <h2 id="CAR"></h2>
        <figure class="Chartjs-figure" id="chart-5-container"></figure>
        <ol class="Chartjs-legend" id="legend-5-container"></ol>
    </div>
    



<script>
function date_update(){
    var dates = [document.getElementById("date_sel").value, 
                 document.getElementById("date_sel1").value];
    dates.sort();
    $.ajax({
        type: "GET",
        url: 'https://4253c6aa.ngrok.io',
        data: 'date='+dates[1]+'&date1='+dates[0],
        datatype: "html",
        success: function(result){
            shopify_data();
        }
    });
};


//get data from cookie
shopify_data();
function shopify_data(){
    var cookie_data = document.cookie.split(/[;=]+/);
    function find_cookie(cookie) {
        var numb = cookie_data.indexOf(cookie);
        numb = cookie_data[numb + 1];
        console.log(cookie + numb);
        return numb;
    }
  
    //SHOPIFY STORE METRIC DATA
    var cookie_data = document.cookie.split(/[;=]+/);
    var AOV = find_cookie(" AOV:");
    var RPR = find_cookie(" RPR:");
    var CLTV = find_cookie(" CLTV:");
    var REV = find_cookie(" REV:");
    var TBP = find_cookie(" TBP:");
    
    //display shopify data
    document.getElementById("AOV").innerHTML = 'SHOP AOV: ' + AOV;
    document.getElementById("RPR").innerHTML = 'SHOP RPR: ' + RPR;
    document.getElementById("TBP").innerHTML = 'SHOP TBP: ' + TBP;
    document.getElementById("REV").innerHTML = 'SHOP REV: ' + REV;
    document.getElementById("CLTV").innerHTML = 'SHOP CLTV: ' + CLTV;
}


//get the date from x days ago, 
//or format the date into the same format as the html form input
function x_days_ago(X, Y){
    var xdate = new Date(Date.now() + -1*X*24*3600*1000);
    if (Y !== 1) {
    var xdate = new Date(Y);
    }
    var dd = xdate.getDate();
    var mm = xdate.getMonth()+1;
    var yyyy = xdate.getFullYear();
    if (dd < 10) {
        dd = '0' + dd;
    }
    if (mm < 10) {
        mm = '0' + mm;
    }
    xdate = yyyy + '-' + mm + '-' + dd ;
    return xdate; 
}
document.getElementById("date_sel").value = x_days_ago(0, 1);
document.getElementById("date_sel1").value = x_days_ago(30, 1);


function create_labels(s_date, e_date){
    s_date = new Date(s_date);
    e_date = new Date(e_date);
    var time_span = (e_date.getTime() - s_date.getTime())/86400000; //convert to days
    var labels = [];
    console.log('create_labels');
    console.log(s_date + ' ' + new Date(s_date).getTime())
    console.log(time_span);
    //week day labels
    if (time_span < 14){
        console.log('short');
        var Day_Names = ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'];
        var day = s_date.getDay(); //get start day
        for (i=0; i < time_span; i++) {
            labels.push(Day_Names[String(day%7)] + ": " + new Date(s_date.getTime() + i*86400000).getDate());
            day += 1; 
        }
    }
    
    //longer view labels
    if (time_span > 13){
        console.log('long');
        var Month_Names = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
        for (i=0; i<time_span+1; i++){
            labels.push(
                Month_Names[(new Date(s_date.getTime() + i*86400000).getMonth())%12] 
                + ': ' 
                + new Date(s_date.getTime() + i*86400000).getDate());
        }
    }
    return labels;
}


gapi.analytics.ready(function() {
  gapi.analytics.auth.authorize({
    container: 'embed-api-auth-container',
    clientid: '592230852734-lbn3oialjcq154tgs6kjm7lepm8e0qfd.apps.googleusercontent.com'
  });
  
  //semi global variables
  var GAOV = [];
  var GREV = [];
  var CR = [];
  var PVV = [];
  var CAR = [];
  var SESS = [];
  var TRAN = [];  
  var GAOV2 = [];
  var GREV2 = [];
  var CR2 = [];
  var PVV2 = [];
  var CAR2 = [];
  var SESS2 = [];
  var TRAN2 = [];  
  var current_data = []; 

  function total(data){
      var total = 0;
      for (i = 0; i < data.length; i++){
          total += data[i];
      }
      return total;
  }
 
  //Create a new ViewSelector2 instance to be rendered inside of an element with the id "view-selector-container".
  var viewSelector = new gapi.analytics.ext.ViewSelector2({
    container: 'view-selector-container'
  })
  .execute();
 
  //event listener
  viewSelector.on('viewChange', function(data) { run(data); });
  function run(data){
      current_data = data;
      var dates = [
          document.getElementById("date_sel").value, 
          document.getElementById("date_sel1").value];
      if (dates[0] == "undefined" || dates[1] == "undefined"){
          return;
      };
      dates.sort(); //sorts incase they input the data the wrong way around.
      var labels = create_labels(dates[0], dates[1]);
      dates.unshift(x_days_ago(0, new Date(new Date(dates[0]).getTime()*2 - new Date(dates[1]).getTime())));
      labels = create_labels(dates[1], dates[2]);
      console.log(dates[1], dates[2]);
      
      renderAverageOrderValue(data.ids, dates, labels);  //aov
      renderConvertionRate(data.ids, dates, labels); //cr
      renderRevenue(data.ids, dates, labels); //rev
      renderPerVisitorValue(data.ids, dates, labels); //pvv
    
      setTimeout(function(){
          renderSessions(data.ids, dates, labels); //transactions
          renderTransactions(data.ids, dates, labels); //sessions
          ShopStage(data.ids); //shop stage
          ShopStage2(data.ids); //shop stage
      }, (1000));
  };
  document.getElementById("date_sel").addEventListener("change", function(){ run(current_data); });
  document.getElementById("date_sel1").addEventListener("change", function(){ run(current_data); });
  
  
  
 function renderAverageOrderValue(ids, dates, labels) {
    var now = moment();
    var thisWeek = query({
      'ids': ids,
      'dimensions': 'ga:date,ga:nthDay',
      'metrics': 'ga:revenuePerTransaction',
      'start-date': dates[1],
      'end-date': dates[2]
    });
    var lastWeek = query({
      'ids': ids,
      'dimensions': 'ga:date,ga:nthDay',
      'metrics': 'ga:revenuePerTransaction',
      'start-date': dates[0],
      'end-date': dates[1]
    });
    Promise.all([thisWeek, lastWeek]).then(function(results) {
      var data1 = results[0].rows.map(function(row) { return +row[2]; });
      var data2 = results[1].rows.map(function(row) { return +row[2]; });
      var data = {
        labels : labels,
        datasets : [
          {
            label: 'Last Week',
            fillColor : 'rgba(220,220,220,0.5)',
            strokeColor : 'rgba(220,220,220,1)',
            pointColor : 'rgba(220,220,220,1)',
            pointStrokeColor : '#fff',
            data : data2
          },
          {
            label: 'This Week',
            fillColor : 'rgba(151,187,205,0.5)',
            strokeColor : 'rgba(151,187,205,1)',
            pointColor : 'rgba(151,187,205,1)',
            pointStrokeColor : '#fff',
            data : data1
          }
        ]
      };
      new Chart(makeCanvas('chart-1-container')).Line(data);
      generateLegend('legend-1-container', data.datasets);
    });
  }
 
  function renderConvertionRate(ids, dates, labels) {
    var now = moment();
    var thisWeek2 = query({
      'ids': ids,
      'dimensions': 'ga:date,ga:nthDay',
      'metrics': 'ga:transactionsPerSession',
      'start-date': dates[1],
      'end-date': dates[2]
    });
    var lastWeek2 = query({
      'ids': ids,
      'dimensions': 'ga:date,ga:nthDay',
      'metrics': 'ga:transactionsPerSession',
      'start-date': dates[0],
      'end-date': dates[1]
    });
    Promise.all([thisWeek2, lastWeek2]).then(function(results) {
      var data1 = results[0].rows.map(function(row) { return +row[2]; });
      var data2 = results[1].rows.map(function(row) { return +row[2]; });
      var data = {
        labels : labels,
        datasets : [
          {
            label: 'Last Week',
            fillColor : 'rgba(220,220,220,0.5)',
            strokeColor : 'rgba(220,220,220,1)',
            pointColor : 'rgba(220,220,220,1)',
            pointStrokeColor : '#fff',
            data : data2
          },
          {
            label: 'This Week',
            fillColor : 'rgba(151,187,205,0.5)',
            strokeColor : 'rgba(151,187,205,1)',
            pointColor : 'rgba(151,187,205,1)',
            pointStrokeColor : '#fff',
            data : data1
          }
        ]
      };
      new Chart(makeCanvas('chart-2-container')).Line(data);
      generateLegend('legend-2-container', data.datasets);
    });
  }
  
  
  
  
  
  
  function renderRevenue(ids, dates, labels) {
    var now = moment();
    var thisWeek3 = query({
      'ids': ids,
      'dimensions': 'ga:date,ga:nthDay',
      'metrics': 'ga:transactionRevenue',
      'start-date': dates[1],
      'end-date': dates[2]
    });
    var lastWeek3 = query({
      'ids': ids,
      'dimensions': 'ga:date,ga:nthDay',
      'metrics': 'ga:transactionRevenue',
      'start-date': dates[0],
      'end-date': dates[1]
    });
    Promise.all([thisWeek3, lastWeek3]).then(function(results) {
      var data1 = results[0].rows.map(function(row) { return +row[2]; });
      var data2 = results[1].rows.map(function(row) { return +row[2]; });
      
      //calcs
      GREV = total(data1);
      GREV2 = total(data2);
      if (SESS != ""){
          PVV = GREV / SESS;
      }
      if (TRAN != ""){
        GAOV = GREV / TRAN;
      }
      if (SESS2 != ""){
          PVV2 = GREV2 / SESS2;
      }
      if (TRAN2 != ""){
        GAOV2 = GREV2 / TRAN2;
      }
      document.getElementById("GREV").innerHTML = 'Revenue: ' + GREV + ' v.s ' + GREV2;
      document.getElementById("GAOV").innerHTML = 'Average Order Value: ' + GAOV + ' v.s ' + GAOV2;
      document.getElementById("PVV").innerHTML = 'Per Visitor Value: ' + PVV + ' v.s' + PVV2;
      var data = {
        labels : labels,
        datasets : [
          {
            label: 'Last Week',
            fillColor : 'rgba(220,220,220,0.5)',
            strokeColor : 'rgba(220,220,220,1)',
            pointColor : 'rgba(220,220,220,1)',
            pointStrokeColor : '#fff',
            data : data2
          },
          {
            label: 'This Week',
            fillColor : 'rgba(151,187,205,0.5)',
            strokeColor : 'rgba(151,187,205,1)',
            pointColor : 'rgba(151,187,205,1)',
            pointStrokeColor : '#fff',
            data : data1
          }
        ]
      };
      new Chart(makeCanvas('chart-3-container')).Line(data);
      generateLegend('legend-3-container', data.datasets);
    });
  }
  
  
  
  
  
  
  
  function renderPerVisitorValue(ids, dates, labels) {
    var now = moment(); 
    var thisWeek4 = query({
      'ids': ids,
      'dimensions': 'ga:date,ga:nthDay',
      'metrics': 'ga:transactionRevenuePerSession',
      'start-date': dates[1],
      'end-date': dates[2]
    });
    var lastWeek4 = query({
      'ids': ids,
      'dimensions': 'ga:date,ga:nthDay',
      'metrics': 'ga:transactionRevenuePerSession',
      'start-date': dates[0],
      'end-date': dates[1]
    });
    Promise.all([thisWeek4, lastWeek4]).then(function(results) {
      var data1 = results[0].rows.map(function(row) { return +row[2]; });
      var data2 = results[1].rows.map(function(row) { return +row[2]; });
      var data = {
        labels : labels,
        datasets : [
          {
            label: 'Last Week',
            fillColor : 'rgba(220,220,220,0.5)',
            strokeColor : 'rgba(220,220,220,1)',
            pointColor : 'rgba(220,220,220,1)',
            pointStrokeColor : '#fff',
            data : data2
          },
          {
            label: 'This Week',
            fillColor : 'rgba(151,187,205,0.5)',
            strokeColor : 'rgba(151,187,205,1)',
            pointColor : 'rgba(151,187,205,1)',
            pointStrokeColor : '#fff',
            data : data1
          }
        ]
      };
      new Chart(makeCanvas('chart-4-container')).Line(data);
      generateLegend('legend-4-container', data.datasets);
    });
  }
  
   function renderTransactions(ids, dates, labels) {
    var now = moment();
    var thisWeek5 = query({
      'ids': ids,
      'dimensions': 'ga:date,ga:nthDay',
      'metrics': 'ga:transactions',
      'start-date': dates[1],
      'end-date': dates[2]
    });
    var lastWeek5 = query({
      'ids': ids,
      'dimensions': 'ga:date,ga:nthDay',
      'metrics': 'ga:transactions',
      'start-date': dates[0],
      'end-date': dates[1]
    });
    Promise.all([thisWeek5, lastWeek5]).then(function(results) {
      var data1 = results[0].rows.map(function(row) { return +row[2]; });
      var data2 = results[1].rows.map(function(row) { return +row[2]; });
      
      TRAN = total(data1);
      if (SESS != ""){
        CR = TRAN / SESS;
      }
      if (GREV != ""){
        GAOV = GREV / TRAN;
      }
      TRAN2 = total(data2);
      if (SESS2 != ""){
        CR2 = TRAN2 / SESS2;
      }
      if (GREV2 != ""){
        GAOV2 = GREV2 / TRAN2;
      }
      document.getElementById("TRAN").innerHTML = 'Transactions: ' + TRAN + ' v.s ' + TRAN2;
      document.getElementById("CR").innerHTML = 'Convertion Rate: ' + CR*100 + '% v.s ' + CR2*100 + '%';
      document.getElementById("GAOV").innerHTML = 'Average Order Value: ' + GAOV + ' v.s ' + GAOV2;
      var data = {
        labels : labels,
        datasets : [
          {
            label: 'Last Week',
            fillColor : 'rgba(220,220,220,0.5)',
            strokeColor : 'rgba(220,220,220,1)',
            pointColor : 'rgba(220,220,220,1)',
            pointStrokeColor : '#fff',
            data : data2
          },
          {
            label: 'This Week',
            fillColor : 'rgba(151,187,205,0.5)',
            strokeColor : 'rgba(151,187,205,1)',
            pointColor : 'rgba(151,187,205,1)',
            pointStrokeColor : '#fff',
            data : data1
          }
        ]
      };
      new Chart(makeCanvas('chart-6-container')).Line(data);
      generateLegend('legend-6-container', data.datasets);
    });
  }
  
   function renderSessions(ids, dates, labels) {
    var now = moment();
    var thisWeek6 = query({
      'ids': ids,
      'dimensions': 'ga:date,ga:nthDay',
      'metrics': 'ga:sessions',
      'start-date': dates[1],
      'end-date': dates[2]
    });
    var lastWeek6 = query({
      'ids': ids,
      'dimensions': 'ga:date,ga:nthDay',
      'metrics': 'ga:sessions',
      'start-date': dates[0],
      'end-date': dates[1]
    });
    Promise.all([thisWeek6, lastWeek6]).then(function(results) {
      var data1 = results[0].rows.map(function(row) { return +row[2]; });
      var data2 = results[1].rows.map(function(row) { return +row[2]; });
      
      SESS = total(data1);
      PVV = GREV / SESS;
      if (TRAN != ""){
        CR = TRAN / SESS;
      }
      SESS2 = total(data2);
      PVV2 = GREV2 / SESS2;
      if (TRAN2 != ""){
        CR2 = TRAN2 / SESS2;
      }
      document.getElementById("SESS").innerHTML = 'Sessions: ' + SESS + ' v.s ' + SESS2;
      document.getElementById("CR").innerHTML = 'Convertion Rate: ' + CR*100 + '% v.s ' + CR2*100 + '%';
      document.getElementById("PVV").innerHTML = 'Per Visitor Value: ' + PVV;
      var data = {
        labels : labels,
        datasets : [
          {
            label: 'Last Week',
            fillColor : 'rgba(220,220,220,0.5)',
            strokeColor : 'rgba(220,220,220,1)',
            pointColor : 'rgba(220,220,220,1)',
            pointStrokeColor : '#fff',
            data : data2
          },
          {
            label: 'This Week',
            fillColor : 'rgba(151,187,205,0.5)',
            strokeColor : 'rgba(151,187,205,1)',
            pointColor : 'rgba(151,187,205,1)',
            pointStrokeColor : '#fff',
            data : data1
          }
        ]
      };
      new Chart(makeCanvas('chart-7-container')).Line(data);
      generateLegend('legend-7-container', data.datasets);
    });
  }
  
  
  
  
//actually a pie chart
function ShopStage(ids) {
    query({
      'ids': ids,
      'dimensions': 'ga:shoppingStage',
      'metrics': 'ga:sessions',
      'sort': '-ga:sessions',
    })
    .then(function(response) {
      var data = [];
      var colors = ['#4D5360','#949FB1','#D4CCC5','#E2EAE9','#F7464A'];
     
      response.rows.forEach(function(row, i) {
        data.push({ value: +row[1], color: colors[i], label: row[0] });
      });
      
      console.log(data);
      console.log(data[0]);
      console.log(data[0].value);
      for (i = 0; i < data.length; i++){
          if (data[i].label == "CHECKOUT_ABANDONMENT"){
             var CBAN = data[i].value 
          }
          if (data[i].label == "CHECKOUT"){
              var CPAG = data[i].value
          }
      }
      CAR = CBAN / CPAG;
      
      new Chart(makeCanvas('chart-5-container')).Doughnut(data);
      generateLegend('legend-5-container', data);
    });
  }
  
  //actually a pie chart
function ShopStage2(ids) {
    query({
      'ids': ids,
      'dimensions': 'ga:shoppingStage',
      'metrics': 'ga:sessions',
      'sort': '-ga:sessions',
    })
    .then(function(response) {
      var data = [];
      var colors = ['#4D5360','#949FB1','#D4CCC5','#E2EAE9','#F7464A'];
     
      response.rows.forEach(function(row, i) {
        data.push({ value: +row[1], color: colors[i], label: row[0] });
      });
      
      console.log(data);
      console.log(data[0]);
      console.log(data[0].value);
      for (i = 0; i < data.length; i++){
          if (data[i].label == "CHECKOUT_ABANDONMENT"){
             var CBAN = data[i].value 
          }
          if (data[i].label == "CHECKOUT"){
              var CPAG = data[i].value
          }
      }
      CAR2 = CBAN / CPAG;
      document.getElementById("CAR").innerHTML = "Checkout Abandonment Rate: " + CAR*100 + '% v.s ' + CAR2*100 + '%';
      
      new Chart(makeCanvas('chart-5-container')).Doughnut(data);
      generateLegend('legend-5-container', data);
    });
  }
  
  
  
  
 
  
  /**
   * Extend the Embed APIs `gapi.analytics.report.Data` component to
   * return a promise the is fulfilled with the value returned by the API.
   * @param {Object} params The request parameters.
   * @return {Promise} A promise.
   */
  function query(params) {
    return new Promise(function(resolve, reject) {
      var data = new gapi.analytics.report.Data({query: params});
      data.once('success', function(response) { resolve(response); })
          .once('error', function(response) { reject(response); })
          .execute();
    });
  }
  /**
   * Create a new canvas inside the specified element. Set it to be the width
   * and height of its container.
   * @param {string} id The id attribute of the element to host the canvas.
   * @return {RenderingContext} The 2D canvas context.
   */
  function makeCanvas(id) {
    var container = document.getElementById(id);
    var canvas = document.createElement('canvas');
    var ctx = canvas.getContext('2d');
    container.innerHTML = '';
    canvas.width = container.offsetWidth;
    canvas.height = container.offsetHeight;
    container.appendChild(canvas);
    return ctx;
  }
  /**
   * Create a visual legend inside the specified element based off of a
   * Chart.js dataset.
   * @param {string} id The id attribute of the element to host the legend.
   * @param {Array.<Object>} items A list of labels and colors for the legend.
   */
  function generateLegend(id, items) {
    var legend = document.getElementById(id);
    legend.innerHTML = items.map(function(item) {
      var color = item.color || item.fillColor;
      var label = item.label;
      return '<li><i style="background:' + color + '"></i>' +
          escapeHtml(label) + '</li>';
    }).join('');
  }
  // Set some global Chart.js defaults.
  Chart.defaults.global.animationSteps = 60;
  Chart.defaults.global.animationEasing = 'easeInOutQuart';
  Chart.defaults.global.responsive = true;
  Chart.defaults.global.maintainAspectRatio = false;
  /**
   * Escapes a potentially unsafe HTML string.
   * @param {string} str An string that may contain HTML entities.
   * @return {string} The HTML-escaped string.
   */
  function escapeHtml(str) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
  }
});
</script>
</body>
</html>
